# 云对象登录校验统一处理方案

_Exported on 2025/5/15 at GMT+8 9:49:16 from Cursor (0.50.4)_

---

**User**

在云对象的\_before 中进行登录的校验，校验了是否登录以及登录是否失效，如果失效或者未登录会抛出异常，然后在页面的 vue 中进行处理，比如跳转到登录页面，这是常规的处理。但是，如果一个云对象有很多函数，那么每个函数都要处理这个逻辑，而且还存在多个云对象的情况，要处理的情况就更多了。请问有没有办法通义一个入口进行处理？请给出你的方案，先不编写代码

---

**Cursor**

好的，这是一个非常棒的想法，通过统一入口处理登录校验可以大大简化代码和提高可维护性。

下面是我的方案，分为云端和前端两部分：

**方案概述：**

1.  **云端**：

    - 创建一个公共的云函数模块（例如 `common/auth-filter/index.js`），专门用于登录状态和 Token 有效性的校验。
    - 这个模块将提供一个校验函数，该函数会检查是否存在 Token、Token 是否由 uni-id 签发（如果使用 uni-id）、Token 是否在有效期内。
    - 如果校验不通过（未登录、Token 无效或过期），该函数会抛出一个具有特定 `errCode`（例如：`'LOGIN_REQUIRED'` 或 `'TOKEN_INVALID'`）和错误信息的 Error 对象。
    - 各个云对象（如 `worker-service`, `site-service`, `work-hour-service`）在其 `_before` 方法中，统一调用这个公共模块的校验函数。

2.  **前端**：
    - **方式一 (项目当前采用)**：在每个调用云对象接口的地方使用 `try...catch` 来捕获错误。当捕获到由云端 `auth-filter` 抛出的特定 `errCode` (例如：`'LOGIN_REQUIRED'` 或 `'TOKEN_INVALID'`) 时，前端执行页面跳转到登录页的逻辑。

**优点：**

- **云端逻辑统一**：登录校验逻辑集中在一个地方，方便修改和维护。
- **云对象简洁**：每个云对象的 `_before` 方法只需一行调用即可。
- **前端处理明确**: 每个 API 调用点都有独立的错误处理逻辑，可以针对性处理。

**详细开发计划：**

在开始编码之前，我会先阅读您提供的开发进度文档 `docs/task.md` 和开发记录 `docs/chat-log.md`，以确保我的方案与项目当前状态和规划一致。

**开发计划步骤：**

1.  **阅读文档**：

    - 仔细阅读 `docs/task.md` 和 `docs/chat-log.md`，了解项目背景、当前进度和已有的约定。

2.  **创建云端公共校验模块**：

    - 在 `uniCloud-aliyun/cloudfunctions/common/` 目录下，创建一个名为 `auth-filter` 的文件夹。
    - 在 `auth-filter` 文件夹下创建 `index.js` 文件。
    - 在 `index.js` 中实现登录校验逻辑：
      - 导出一个名为 `checkLogin` 的异步函数（或者普通函数，取决于内部是否有异步操作如数据库查询）。
      - 函数内部获取客户端信息，特别是 `uniIdToken`。
      - 检查 `uniIdToken` 是否存在。若不存在，抛出错误，如 `{ errCode: 'LOGIN_REQUIRED', errMsg: '用户未登录' }`。
      - 如果存在 `uniIdToken`，则调用 `uniCloud.checkToken(uniIdToken)`（或者您自定义的 Token 校验方法）来验证 Token 的有效性。
      - 如果 `checkToken` 返回错误或表明 Token 无效/过期，则抛出相应的错误，如 `{ errCode: 'TOKEN_INVALID', errMsg: '登录已过期，请重新登录' }` 或直接透传 `checkToken` 的错误。
      - 如果校验通过，则函数正常返回，不抛出任何错误。
    - 添加必要的 `console.log` 方便调试。

3.  **修改各云对象的 `_before` 方法**：

    - 引入 `common/auth-filter/index.js` 中的 `checkLogin` 函数。
    - 在每个云对象（`worker-service/index.obj.js`, `site-service/index.obj.js`, `work-hour-service/index.obj.js` 等）的 `_before` 方法中，调用 `await checkLogin.call(this)` 或 `checkLogin.call(this)`（取决于 `checkLogin` 是否是异步的）。使用 `.call(this)` 是为了确保 `checkLogin` 函数内部的 `this` 指向当前的云对象实例，从而可以访问 `this.getUniIdToken()` 等方法。

基于此，之前提出的 **"云端创建公共校验模块，各云对象 `_before` 调用，前端统一处理错误"** 的方案依然是合适的。
